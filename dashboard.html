<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Jungle Cubs Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- THEME COLORS --- */
    :root { 
      --bg: #f0f2f5; --sidebar: #ffffff; --active: #e8f5e9; 
      --green: #287844; --text: #333; --border: #e0e0e0; --red: #c72e31; --orange: #f39c12;
      --blue: #2196F3;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }
    
    /* --- SCROLLBARS --- */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    /* --- LAYOUT (DESKTOP) --- */
    .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 1000; transition: transform 0.3s ease; position: relative; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
    
    /* --- MOBILE HEADER --- */
    .mobile-header { display: none; background: white; padding: 0 15px; border-bottom: 1px solid #ddd; align-items: center; justify-content: space-between; z-index: 2000; position: fixed; top: 0; left: 0; width: 100%; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .menu-btn { font-size: 28px; cursor: pointer; color: var(--green); background: none; border: none; padding: 0; }
    
    /* --- NAVIGATION & SIDEBAR ITEMS --- */
    .logo-container { text-align: center; margin-bottom: 10px; }
    .logo-img { max-width: 140px; height: auto; display: block; margin: 0 auto; }
    .welcome-text { text-align: center; color: var(--green); font-weight: bold; font-size: 14px; margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    
    .nav-item { padding: 12px 15px; margin-bottom: 8px; cursor: pointer; border-radius: 8px; font-weight: 500; color: #555; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .nav-item:hover { background-color: #f5f5f5; color: var(--green); }
    .nav-item.active { background-color: var(--active); color: var(--green); font-weight: bold; }
    
    .sidebar-close-btn { display: none; position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: #888; cursor: pointer; }
    
    /* --- VIEWS --- */
    .view-section { display: none; animation: fadeIn 0.3s ease-out; padding-bottom: 100px; } 
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

    h2 { margin-top: 0; color: #2c3e50; border-bottom: 3px solid var(--green); display: inline-block; padding-bottom: 5px; margin-bottom: 20px; font-size: 22px; }

    /* --- HOME TAB --- */
    .home-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 60vh; text-align: center; color: #444; }
    .big-time { font-size: 70px; font-weight: 300; color: var(--green); margin-bottom: 5px; letter-spacing: -2px; line-height: 1; }
    .big-date { font-size: 18px; font-weight: 500; color: #666; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 1px; }
    .quote-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); max-width: 600px; border-left: 5px solid var(--orange); margin: 0 15px; }
    .quote-text { font-size: 18px; font-style: italic; color: #555; line-height: 1.4; }
    .quote-author { margin-top: 15px; font-weight: bold; color: var(--green); display: block; font-size: 13px; text-transform: uppercase; }

    /* --- PENDING APPROVAL CARDS --- */
    .pending-card { background: white; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; border: 1px solid #eee; }
    .pc-header { padding: 12px 15px; background: #f9f9f9; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .pc-name { font-weight: bold; font-size: 16px; color: #333; }
    .pc-days { font-size: 12px; font-weight: bold; color: #666; background: #eee; padding: 3px 8px; border-radius: 4px; }
    .pc-body { padding: 15px; }
    .pc-dates { font-size: 14px; color: #555; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
    .pc-reason { font-style: italic; color: #777; background: #fafafa; padding: 8px; border-radius: 6px; font-size: 13px; margin-bottom: 12px; border-left: 3px solid #ddd; }
    .pc-limit-badge { display: inline-block; font-size: 11px; font-weight: bold; padding: 4px 8px; border-radius: 4px; margin-bottom: 5px; }
    .limit-ok { background: #e8f5e9; color: var(--green); border: 1px solid #c8e6c9; }
    .limit-bad { background: #fdecea; color: var(--red); border: 1px solid #ffcdd2; }
    
    .pc-conflict { font-size: 12px; padding: 8px; background: #fff8e1; border: 1px solid #ffe0b2; color: #f57f17; border-radius: 4px; margin-bottom: 12px; }
    .pc-conflict-none { font-size: 12px; padding: 8px; background: #f1f8e9; border: 1px solid #dcedc8; color: var(--green); border-radius: 4px; margin-bottom: 12px; }

    .pc-actions { display: flex; gap: 10px; margin-top: 10px; }
    .btn-approve, .btn-reject { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 14px; transition: opacity 0.2s; }
    .btn-approve { background: var(--green); }
    .btn-reject { background: var(--red); }
    .btn-approve:active, .btn-reject:active { opacity: 0.7; }

    /* --- HISTORY LIST --- */
    .history-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; display: flex; flex-direction: column; gap: 5px; }
    .h-Approved { border-left-color: var(--green); }
    .h-Rejected { border-left-color: var(--red); }
    .h-Pending { border-left-color: var(--orange); }
    .h-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .h-name { font-weight: bold; font-size: 16px; color: #333; }
    .h-status { font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: bold; text-transform: uppercase; }
    .st-Approved { background: #e8f5e9; color: var(--green); }
    .st-Rejected { background: #fdecea; color: var(--red); }
    .st-Pending { background: #fff3cd; color: var(--orange); }
    .h-date { font-size: 13px; color: #555; display: flex; align-items: center; gap: 5px; margin-top: 5px; }
    .h-reason { font-size: 13px; color: #777; font-style: italic; margin-top: 5px; background: #f9f9f9; padding: 8px; border-radius: 6px; }

    /* --- ATTENDANCE LIST --- */
    .att-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .att-col { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .att-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .att-item:last-child { border-bottom: none; }
    .att-left { display: flex; flex-direction: column; gap: 3px; }
    .att-emp { font-weight: bold; font-size: 15px; color: #333; }
    .att-place { font-size: 12px; color: #888; display: flex; align-items: center; gap: 4px; }
    .att-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .att-badge { font-size: 10px; font-weight: bold; padding: 3px 6px; border-radius: 4px; display: inline-block; }
    .ab-in { background: #e8f5e9; color: var(--green); }
    .ab-out { background: #eee; color: #666; }
    .att-time { font-size: 13px; font-weight: 500; color: #444; }
    .att-late { background: #c72e31; color: white; font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 5px; }
    .btn-force { background: #fff0f0; border: 1px solid #ffcccc; color: var(--red); font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-top: 4px; }

    /* --- TEAM STATS --- */
    .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
    .member-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; border: 1px solid #eee; }
    .member-avatar { width: 50px; height: 50px; background: var(--green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; margin: 0 auto 10px; }
    .progress-bar { background: #eee; height: 8px; border-radius: 4px; margin: 15px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--green); border-radius: 4px; }

    /* --- CALENDAR --- */
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: white; border-radius: 0 0 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .cal-cell { min-height: 80px; border: 1px solid #f0f0f0; padding: 5px; position: relative; }
    .cal-day-name { text-align: center; font-weight: bold; color: #888; padding: 10px; background: #f9f9f9; font-size: 12px; text-transform: uppercase; }
    .cal-date-num { font-size: 12px; font-weight: bold; color: #333; margin-bottom: 5px; display: inline-block; width: 25px; height: 25px; line-height: 25px; text-align: center; border-radius: 50%; }
    .cal-date-num.today { background: var(--green); color: white; }
    .cal-event { font-size: 10px; background: #e8f5e9; color: var(--green); padding: 2px 5px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-left: 2px solid var(--green); }

    /* --- ALLOCATIONS (Desktop) --- */
    .alloc-layout { display: flex; gap: 20px; height: calc(100vh - 280px); }
    .alloc-sidebar { width: 220px; background: white; border-radius: 8px; padding: 15px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
    .alloc-main { flex: 1; overflow-y: auto; padding-right: 5px; }
    .alloc-summary-panel { width: 260px; background: white; border-radius: 8px; padding: 15px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; border-left: 4px solid #333; }
    .alloc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
    
    /* Alloc Toolbar */
    .alloc-toolbar { background: white; padding: 10px; border-radius: 12px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; flex-wrap: wrap; }
    .btn-group { display: flex; gap: 5px; }
    .btn-tool { padding: 8px 12px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 6px; cursor: pointer; color: #555; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
    .btn-tool:hover { background: #eee; }
    .btn-action { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    .city-header { font-size: 16px; color: var(--green); border-bottom: 2px solid #ddd; padding-bottom: 5px; margin: 20px 0 10px 0; font-weight: bold; }
    .staff-pill { padding: 5px 10px; border-radius: 6px; font-size: 12px; margin-bottom: 5px; display: flex; justify-content: space-between; cursor: grab; }
    .pill-leave { background: #fdecea; color: #c72e31; border: 1px solid #fababb; }
    .pill-free { background: #e8f5e9; color: var(--green); border: 1px solid #c8e6c9; }
    .pill-busy { background: #f5f5f5; color: #999; border: 1px solid #ddd; opacity: 0.8; }
    
    .live-cal-icon { width: 45px; height: 48px; background: white; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-right: 12px; flex-shrink: 0; }
    .live-cal-month { background: #c72e31; color: white; font-size: 10px; padding: 4px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
    .live-cal-day { font-size: 22px; font-weight: bold; color: #333; flex: 1; display: flex; align-items: center; justify-content: center; line-height: 1; background: #fff; }

    .staff-select { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-bottom: 6px; background: #fff; height: 32px; }
    .min-req-msg { color: #c72e31; font-size: 11px; font-weight: bold; margin-top: 5px; display: none; }
    .card-error { border: 2px solid #c72e31 !important; background-color: #fff5f5 !important; }
    .card-error .min-req-msg { display: block; }

    /* --- LOGIN --- */
    #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--green); display: flex; justify-content: center; align-items: center; z-index: 3000; }
    .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 90%; max-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    #pinInput { width: 100%; padding: 12px; font-size: 18px; text-align: center; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 6px; }

    /* =========================================
       üì± MOBILE RESPONSIVE OVERRIDES
       ========================================= */
    @media (max-width: 768px) {
        body { flex-direction: column; padding-top: 60px; height: auto; overflow: auto; }
        .mobile-header { display: flex; }
        .sidebar { position: fixed; left: -100%; top: 60px; width: 85%; height: calc(100vh - 60px); z-index: 2500; border-right: none; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .sidebar.active { left: 0; }
        .sidebar-close-btn { display: block; }
        .main-content { padding: 15px; width: 100%; height: auto; overflow: visible; }

        /* Home - Fix Viewport Cutoff */
        .big-time { font-size: 50px; }
        .home-container { min-height: 50vh; justify-content: flex-start; padding-top: 40px; }

        /* Allocations Layout: Vertical Stack */
        .alloc-layout { flex-direction: column; height: auto; gap: 0; }
        
        /* 1. Mobile Toolbar */
        .alloc-toolbar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-group { grid-column: span 2; display: flex; justify-content: space-between; gap: 5px; }
        .btn-tool { flex: 1; justify-content: center; font-size: 11px; padding: 8px 4px; text-align: center; }
        .btn-action-group { grid-column: span 2; display: flex; gap: 10px; margin-top: 5px; }
        .btn-action { flex: 1; padding: 12px; }

        /* 2. SPLIT VIEW POOL (Sticky Top, 40% Height) */
        .alloc-sidebar { 
            position: sticky; top: 60px; z-index: 900; 
            width: 100%; 
            height: 40vh; /* Takes 40% of screen */
            overflow-y: auto; 
            border-bottom: 4px solid var(--green);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            order: -1; 
            display: block; 
        }
        
        /* 3. Cards */
        .alloc-grid { grid-template-columns: 1fr; gap: 20px; }
        .staff-select { height: 45px; font-size: 16px; margin-bottom: 12px; }
        
        /* Attendance & Stats */
        .att-split, .team-grid { grid-template-columns: 1fr; }
        .att-col { margin-bottom: 15px; }
        
        /* 4. Mobile Calendar Fix */
        .cal-grid { grid-template-columns: repeat(7, 1fr); }
        .cal-cell { min-height: 60px; font-size: 10px; padding: 2px; }
        .cal-event { display: block; font-size: 9px; padding: 2px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    }
  </style>
</head>
<body>

  <div class="mobile-header">
      <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
      <img src="https://junglecubsgyms.com/imgw/logo_light.png" alt="Logo" style="height:30px;">
      <div style="width:28px;"></div>
  </div>

  <div id="login-screen">
    <div class="login-box">
      <img src="https://junglecubsgyms.com/imgw/logo_light.png" alt="Logo" class="logo-img" style="margin-bottom:20px;">
      <h2 style="border:none; color:var(--green); margin-bottom:10px;">Welcome, Aparna!</h2>
      <p style="color:#666; margin-bottom:20px; font-size:14px;">Enter Admin PIN</p>
      <input type="password" id="pinInput" placeholder="PIN">
      <button onclick="checkPin()" class="btn-approve" style="width:100%; font-size:16px;">Access Dashboard</button>
    </div>
  </div>

  <div class="sidebar" id="mySidebar">
    <button class="sidebar-close-btn" onclick="toggleMenu()">√ó</button>
    <div class="logo-container">
        <img src="https://junglecubsgyms.com/imgw/logo_light.png" alt="Logo" class="logo-img">
    </div>
    <div class="welcome-text">Welcome, Aparna</div>
    
    <div class="nav-item active" onclick="switchTab('home'); toggleMenu()">üè† Dashboard</div>
    <div class="nav-item" onclick="switchTab('pending'); toggleMenu()">üîî Pending Approvals</div>
    <div class="nav-item" onclick="switchTab('attendance'); toggleMenu()">üìç Live Attendance</div>
    <div class="nav-item" onclick="switchTab('allocation'); toggleMenu()">üè¢ Centre Allocations</div>
    <div class="nav-item" onclick="switchTab('calendar'); toggleMenu()">üìÖ Calendar</div>
    <div class="nav-item" onclick="switchTab('history'); toggleMenu()">üìú Leave History</div>
    <div class="nav-item" onclick="switchTab('team'); toggleMenu()">üë• Team Stats</div>
    
    <button onclick="fetchData()" style="width:100%; margin-top:auto; padding:10px; background:white; border:1px solid #ddd; border-radius:6px; cursor:pointer; color:#666; font-size:12px;">üîÑ Refresh Data</button>
    <button onclick="logout()" style="width:100%; margin-top:10px; padding:10px; background:#fdecea; border:1px solid #c72e31; border-radius:6px; cursor:pointer; color:#c72e31; font-weight:bold; font-size:12px;">üö™ Logout</button>
    <div id="loading-indicator" style="margin-top:10px; text-align:center; font-size:11px; color:#aaa; display:none;">Syncing...</div>
  </div>

  <div class="main-content">
    
    <div id="view-home" class="view-section active">
        <div class="home-container">
            <div id="live-time" class="big-time">--:--</div>
            <div id="live-date" class="big-date">-- -- ----</div>
            <div class="quote-box">
                <div id="daily-quote" class="quote-text">"Loading inspiration..."</div>
                <span id="quote-author" class="quote-author"></span>
            </div>
            <p style="margin-top:40px; font-size:13px; color:#999;">
                System Status: <span id="sys-status" style="color:var(--orange);">Initializing...</span>
            </p>
        </div>
    </div>

    <div id="view-pending" class="view-section">
      <h2>Pending Actions</h2>
      <div id="pending-container">Loading...</div>
    </div>

    <div id="view-attendance" class="view-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 id="att-header-date">Live Attendance</h2>
        <button onclick="forceOutAll()" style="background:#c72e31; color:white; border:none; padding:8px 15px; border-radius:4px; font-size:12px; cursor:pointer;">‚ö†Ô∏è Force Close All</button>
      </div>
      <div class="att-split">
        <div class="att-col">
          <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">‚òÄÔ∏è Morning (HO)</h3>
          <div id="att-morning"><p style="color:#999;">No check-ins yet.</p></div>
        </div>
        <div class="att-col">
          <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üåô Evening (Centres)</h3>
          <div id="att-evening"><p style="color:#999;">No check-ins yet.</p></div>
        </div>
      </div>
    </div>

    <div id="view-allocation" class="view-section">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="display:flex; align-items:center;">
                <div class="live-cal-icon">
                    <div class="live-cal-month" id="icon-month">JAN</div>
                    <div class="live-cal-day" id="icon-day">01</div>
                </div>
                <h2 style="margin:0; border:none; padding:0;">Centre Allocations</h2>
                <div id="plan-status" style="margin-left:15px; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:bold; background:#eee; color:#666;">‚ö™ Checking</div>
            </div>
            
            <div style="display:flex; align-items:center; gap:5px; background:white; padding:5px; border-radius:6px; border:1px solid #ddd;">
                <button onclick="changeDate(-1)" style="border:none; background:none; cursor:pointer; font-weight:bold; padding:5px 10px;">‚óÄ</button>
                <input type="date" id="allocDate" onchange="loadAllocations()" style="border:none; outline:none; font-family:inherit; font-weight:500;">
                <button onclick="changeDate(1)" style="border:none; background:none; cursor:pointer; font-weight:bold; padding:5px 10px;">‚ñ∂</button>
            </div>
        </div>

        <div class="alloc-toolbar">
            <div class="btn-group">
                <button onclick="undo()" id="btn-undo" class="btn-tool" disabled>‚Ü© Undo</button>
                <button onclick="redo()" id="btn-redo" class="btn-tool" disabled>‚Ü™ Redo</button>
                <button onclick="copyPlan(-1)" class="btn-tool">üìÑ Copy Yest.</button>
                <button onclick="copyPlan(-7)" class="btn-tool">üìÖ Copy Last Wk</button>
            </div>
            <div class="btn-action-group">
                <button onclick="resetPlan()" class="btn-action" style="background:#f39c12; color:white;">‚ú® Reset</button>
                <button onclick="savePlan()" class="btn-action" style="background:#287844; color:white;">üíæ Save Changes</button>
            </div>
        </div>

        <div class="alloc-layout">
            <div class="alloc-sidebar">
                <div style="font-size:11px; font-weight:bold; color:#999; margin-bottom:5px;">STAFF POOL</div>
                <div><strong style="color:#c72e31; font-size:11px;">üî¥ On Leave</strong><div id="pool-leave" style="margin-top:5px;"></div></div>
                <hr style="border:0; border-top:1px solid #eee; width:100%;">
                <div><strong style="color:var(--green); font-size:11px;">üü¢ Available</strong><div id="pool-free" style="margin-top:5px;"></div></div>
            </div>

            <div class="alloc-main" id="alloc-board"></div>

            <div class="alloc-summary-panel">
                <div style="font-size:11px; font-weight:bold; color:#999; margin-bottom:5px;">SUMMARY PREVIEW</div>
                <div id="summary-text" style="flex:1; font-size:11px; white-space:pre-wrap; font-family:monospace; background:#f9f9f9; padding:10px; border:1px solid #eee; border-radius:4px; overflow-y:auto; color:#333; max-height:300px;">Loading...</div>
                <button onclick="copySummary()" style="margin-top:10px; width:100%; background:#25D366; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">üì± Copy for WhatsApp</button>
            </div>
        </div>
    </div>

    <div id="view-calendar" class="view-section">
      <h2>Leave Calendar</h2>
      <div class="cal-header">
        <button class="cal-btn" onclick="changeMonth(-1)">‚óÄ Prev</button>
        <strong id="cal-month-year" style="font-size:16px;">--</strong>
        <button class="cal-btn" onclick="changeMonth(1)">Next ‚ñ∂</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>

    <div id="view-history" class="view-section">
      <h2>Leave History</h2>
      <input type="text" id="searchBox" onkeyup="filterHistory()" placeholder="Search name..." style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:15px; font-size:16px;">
      <div id="history-list-container"></div> </div>

    <div id="view-team" class="view-section">
      <h2>Team Stats</h2>
      <div class="team-grid" id="team-grid"></div>
    </div>

  </div> <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzUTLI-Oc604ZA-jOfA785fp4PVHwqJXzWNyOLzB8lkDQa4z1csNO1dRRK6IoLs5OnSBw/exec'; 
    const CORRECT_PIN = "1234"; 
    let dashboardData = {}, globalHolidays = {}, currentCalDate = new Date();
    let currentTab = 'home';
    let hasUnsavedChanges = false;

    const quotes = [
        { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
        { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
        { text: "Leadership is not about being in charge. It is about taking care of those in your charge.", author: "Simon Sinek" }
    ];

    function updateTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const mins = String(now.getMinutes()).padStart(2, '0');
        const dNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        const mNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        document.getElementById('live-time').innerText = hours + ":" + mins;
        document.getElementById('live-date').innerText = dNames[now.getDay()] + ", " + now.getDate() + " " + mNames[now.getMonth()] + " " + now.getFullYear();
        
        const attHeader = document.getElementById('att-header-date');
        if(attHeader) attHeader.innerHTML = `Live Attendance <span style='font-size:14px; color:#666; font-weight:normal; display:block;'>${dNames[now.getDay()]}, ${now.getDate()} ${mNames[now.getMonth()]}</span>`;
    }
    setInterval(updateTime, 1000); updateTime();
    const rq = quotes[Math.floor(Math.random() * quotes.length)];
    document.getElementById('daily-quote').innerText = '"' + rq.text + '"'; document.getElementById('quote-author').innerText = "- " + rq.author;

    function checkPin() { 
        if(document.getElementById('pinInput').value===CORRECT_PIN){ 
            document.getElementById('login-screen').style.display='none'; 
            window.scrollTo(0,0); // FIX SCROLL
            initDashboard(); 
        } else alert("Wrong PIN"); 
    }
    function logout() { location.reload(); }

    function initDashboard() { switchTab('home'); document.getElementById('sys-status').innerText = "Connecting..."; document.getElementById('loading-indicator').style.display='block'; fetch(SCRIPT_URL + "?action=getHolidays").then(r=>r.json()).then(d=>{ globalHolidays=d; fetchData(); }).catch(e=>fetchData()); }
    function fetchData() { document.getElementById('sys-status').innerText = "Fetching Records..."; fetch(SCRIPT_URL + "?action=getDashboardData").then(r=>r.json()).then(d=>{ dashboardData=d; renderAll(); document.getElementById('sys-status').innerText="‚úÖ System Ready."; document.getElementById('sys-status').style.color="var(--green)"; document.getElementById('loading-indicator').style.display='none'; }).catch(e=>console.error(e)); }
    function renderAll() { renderPending(); renderAttendance(); renderHistory(); renderTeam(); renderCalendar(); }

    function switchTab(t) {
        // UNSAVED CHANGES CHECK
        if(currentTab === 'allocation' && hasUnsavedChanges && t !== 'allocation') {
            if(!confirm("‚ö†Ô∏è You have unsaved changes in Allocations.\n\nDiscard changes and switch tabs?")) return;
            hasUnsavedChanges = false; // Discarded
        }
        
        currentTab = t;
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el=>{ if(el.getAttribute('onclick')&&el.getAttribute('onclick').includes(t)) el.classList.add('active'); });
        document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));
        if(document.getElementById('view-'+t)) document.getElementById('view-'+t).classList.add('active');
        if(t==='allocation') { 
            if(!document.getElementById('allocDate').value) { let x=new Date(); document.getElementById('allocDate').value=x.getFullYear()+'-'+String(x.getMonth()+1).padStart(2,'0')+'-'+String(x.getDate()).padStart(2,'0'); }
            loadAllocations(); 
        }
    }
    function toggleMenu() { document.getElementById("mySidebar").classList.toggle("active"); }

    // --- CONFLICT CHECK LOGIC ---
    function getConflicts(pStart, pEnd, pName) {
        let s1 = parseDate(pStart), e1 = parseDate(pEnd);
        let conflicts = [];
        if(dashboardData.history) {
            dashboardData.history.forEach(h => {
                if(h.status === "Approved" && h.name !== pName) { 
                    let s2 = parseDate(h.start), e2 = parseDate(h.end);
                    if (s1 <= e2 && e1 >= s2) { conflicts.push(h.name); }
                }
            });
        }
        return [...new Set(conflicts)];
    }

    function renderPending() {
        var c = document.getElementById('pending-container'); c.innerHTML="";
        if(!dashboardData.pending || !dashboardData.pending.length) { c.innerHTML="<p>All caught up!</p>"; return; }
        dashboardData.pending.forEach(l => {
            var used = l.usedLeaves || 0; var limit = l.totalLimit || 0; var total = used + l.days;
            var isOver = (limit > 0 && total > limit);
            var badgeClass = isOver ? "limit-bad" : "limit-ok";
            var badgeText = isOver ? `‚ö†Ô∏è Over Limit (${total}/${limit})` : `‚úÖ Within Limit (${total}/${limit})`;
            
            var confs = getConflicts(l.start, l.end, l.name);
            var confHtml = confs.length > 0 
                ? `<div class="pc-conflict">‚ö†Ô∏è Others on Leave: <strong>${confs.join(", ")}</strong></div>`
                : `<div class="pc-conflict-none">‚úÖ No other leaves during this period</div>`;

            var card = document.createElement('div'); card.className = 'pending-card';
            card.innerHTML = `
                <div class="pc-header"><div class="pc-name">${l.name}</div><div class="pc-days">${l.days} Days</div></div>
                <div class="pc-body">
                    <div class="pc-limit-badge ${badgeClass}">${badgeText}</div>
                    ${confHtml}
                    <div class="pc-dates">üìÖ ${l.start} ‚ûù ${l.end}</div>
                    <div class="pc-reason">"${l.reason}"</div>
                    <div class="pc-actions">
                        <button class="btn-approve" onclick="decide(${l.rowIndex},'Approved')">Approve</button>
                        <button class="btn-reject" onclick="decide(${l.rowIndex},'Rejected')">Reject</button>
                    </div>
                </div>
            `;
            c.appendChild(card);
        });
    }

    function renderAttendance() {
        var logs = dashboardData.attendance||[]; var m=document.getElementById('att-morning'); var e=document.getElementById('att-evening');
        var grp={}; 
        logs.forEach(l=>{ 
            var k=l.code+"_"+l.session; if(!grp[k]) grp[k]={code:l.code,name:l.name,loc:l.location,sess:l.session,in:"--:--",out:"--:--",stat:"Absent",cls:"ab-out"};
            if(l.action==="Check-In"){ grp[k].in=l.timestamp; grp[k].stat="Checked In"; grp[k].cls="ab-in"; if(l.isLate) grp[k].late=true; }
            else if(l.action==="Check-Out"){ grp[k].out=l.timestamp; grp[k].stat="Checked Out"; grp[k].cls="ab-out"; }
        });
        var mH="", eH="";
        for(var k in grp){
            var i=grp[k]; var lb=i.late?`<span class="att-late">LATE</span>`:"";
            var btn=(i.stat==="Checked In")?`<div class="btn-force" onclick="forceOut('${i.code}','${i.name}','${i.sess}')">Force Out</div>`:"";
            var h=`<div class="att-item"><div class="att-left"><div class="att-emp">${i.name}</div><div class="att-place">üìç ${i.loc}</div></div><div class="att-right"><span class="att-badge ${i.cls}">${i.stat}</span>${btn}<div class="att-time">‚¨á ${i.in} ${lb}</div><div class="att-time" style="color:#888;">‚¨Ü ${i.out}</div></div></div>`;
            if(i.sess.includes("Morning")) mH+=h; else eH+=h;
        }
        m.innerHTML=mH||"<p style='color:#ccc; font-size:13px;'>Empty</p>"; e.innerHTML=eH||"<p style='color:#ccc; font-size:13px;'>Empty</p>";
    }

    function renderHistory() {
        var c = document.getElementById('history-list-container'); c.innerHTML="";
        if(!dashboardData.history) return;
        dashboardData.history.forEach(r => {
            var div = document.createElement('div'); div.className = 'history-card h-'+r.status;
            div.innerHTML = `<div class="h-header"><div class="h-name">${r.name}</div><div class="h-status st-${r.status}">${r.status}</div></div><div class="h-date">üìÖ ${r.start} - ${r.end} (${r.days}d)</div><div class="h-reason">"${r.reason}"</div>`;
            c.appendChild(div);
        });
    }

    function renderTeam() {
        var g = document.getElementById('team-grid'); g.innerHTML="";
        if(!dashboardData.employees) return;
        dashboardData.employees.forEach(e => {
            var pct = e.limit>0 ? Math.min(100, (e.used/e.limit)*100) : 0;
            g.innerHTML += `<div class="member-card"><div class="member-avatar">${e.name.charAt(0)}</div><h3>${e.name}</h3><div style="font-size:12px; color:#999;">${e.code}</div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%; background:${pct>90?'var(--red)':'var(--green)'}"></div></div><div style="font-size:13px; margin-top:5px;">Used: <strong>${e.used}</strong> / ${e.limit}</div></div>`;
        });
    }

    function renderCalendar() {
        const y=currentCalDate.getFullYear(), m=currentCalDate.getMonth();
        const mNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        document.getElementById('cal-month-year').innerText = mNames[m]+" "+y;
        const fDay=new Date(y,m,1).getDay(), nDays=new Date(y,m+1,0).getDate();
        const g=document.getElementById('cal-grid'); g.innerHTML="";
        ["S","M","T","W","T","F","S"].forEach(d=>g.innerHTML+=`<div class="cal-day-name">${d}</div>`);
        for(let i=0; i<fDay; i++) g.innerHTML+=`<div class="cal-cell"></div>`;
        for(let d=1; d<=nDays; d++) {
            let isT = (d===new Date().getDate() && m===new Date().getMonth());
            let k = y+"-"+(m+1)+"-"+d;
            let h = `<div class="cal-cell"><div class="${isT?'cal-date-num today':'cal-date-num'}">${d}</div>`;
            if(globalHolidays[k]) h+=`<div class="cal-event" style="background:#fdecea; color:red;">‚òÖ ${globalHolidays[k]}</div>`;
            if(dashboardData.history) dashboardData.history.forEach(l=>{
                if(l.status==="Approved"){ let s=parseDate(l.start), e=parseDate(l.end); s.setHours(0,0,0,0); e.setHours(0,0,0,0); let c=new Date(y,m,d);
                if(c>=s && c<=e) h+=`<div class="cal-event">${l.name}</div>`; }
            });
            g.innerHTML += h+"</div>";
        }
    }

    // --- ALLOCATION LOGIC ---
    let globalStaff=[], globalCentres=[], globalLeaves=[], historyStack=[], redoStack=[], isInternalUpdate=false, tempSnapshot=null;

    function loadAllocations() {
        var d = document.getElementById('allocDate').value; if(!d) return;
        var dojb = new Date(d);
        document.getElementById('icon-month').innerText = dojb.toLocaleString('default', { month: 'short' });
        document.getElementById('icon-day').innerText = String(dojb.getDate()).padStart(2, '0');
        document.getElementById('alloc-board').innerHTML = '<p style="padding:20px; text-align:center;">Loading...</p>';
        historyStack=[]; redoStack=[]; updateHistoryButtons(); hasUnsavedChanges=false;
        fetch(SCRIPT_URL + "?action=getAllocationData&date=" + d).then(r=>r.json()).then(data=>{
            globalStaff=data.staff; globalCentres=data.centres; globalLeaves=data.leaves; renderBoard(data.savedPlan);
        });
    }

    function renderBoard(plan) {
        var b = document.getElementById('alloc-board'); b.innerHTML = "";
        var cityMap = {}; globalCentres.forEach(c => { if(!cityMap[c.city]) cityMap[c.city]=[]; cityMap[c.city].push(c); });
        for(var city in cityMap) {
            var sec = document.createElement("div"); sec.innerHTML=`<div class="city-header">${city}</div>`;
            var gr = document.createElement("div"); gr.className="alloc-grid";
            cityMap[city].forEach(cen => { gr.appendChild(createCard(cen, plan)); });
            sec.appendChild(gr); b.appendChild(sec);
        }
        updateAvailability();
    }

    function createCard(c, plan) {
        var d = document.createElement("div"); d.className="card"; d.id="card-"+c.code;
        d.innerHTML = `<h3 style="margin:0 0 10px 0; font-size:15px;">${c.name}</h3>`;
        var vals = ["","","",""];
        if(plan && plan[c.code]) vals=plan[c.code];
        
        for(let i=0; i<4; i++) {
            let sel = document.createElement("select"); sel.className="staff-select"; 
            sel.setAttribute("data-c", c.code); sel.setAttribute("data-n", c.name); sel.setAttribute("data-city", c.city);
            let opt0 = document.createElement("option"); opt0.value=""; opt0.text= (i===0?"Lead":"Educator "+(i+1)) + " (Select)"; sel.appendChild(opt0);
            
            // Initial Populate (Alphabetical)
            globalStaff.sort((a,b)=>a.name.localeCompare(b.name)).forEach(s=>{
                let opt = document.createElement("option"); opt.value=s.code; opt.text=s.name;
                if(s.code===vals[i]) opt.selected=true; sel.appendChild(opt);
            });
            
            sel.addEventListener('focus', ()=>tempSnapshot=getBoardState());
            sel.addEventListener('change', ()=>{ 
                hasUnsavedChanges = true;
                if(tempSnapshot){ historyStack.push(tempSnapshot); redoStack=[]; updateHistoryButtons(); } 
                updateAvailability(); 
            });
            d.appendChild(sel);
        }
        var msg = document.createElement("div"); msg.className="min-req-msg"; msg.innerText="‚ö†Ô∏è Min 2 req."; d.appendChild(msg);
        return d;
    }

    function updateAvailability() {
        var sels = document.querySelectorAll('.staff-select');
        var assigned=[], counts={}, filled=0, err=false;
        
        // 1. Gather Assigned
        sels.forEach(s=>{ if(s.value){ assigned.push(s.value); if(!counts[s.getAttribute("data-c")]) counts[s.getAttribute("data-c")]=0; counts[s.getAttribute("data-c")]++; filled++; } });
        
        // 2. Disable Busy + SMART SORT (Move Available to Top)
        sels.forEach(s=>{
            var curr = s.value;
            var opts = Array.from(s.options);
            var def = opts[0]; // Keep default top
            
            // Re-sort: Available first, Busy last
            var rest = opts.slice(1).sort((a, b) => {
                var aBusy = (a.value && assigned.includes(a.value) && a.value !== curr);
                var bBusy = (b.value && assigned.includes(b.value) && b.value !== curr);
                if (aBusy === bBusy) return a.text.localeCompare(b.text);
                return aBusy ? 1 : -1; 
            });
            
            s.innerHTML = ""; s.appendChild(def);
            rest.forEach(o => {
                o.disabled = (o.value && assigned.includes(o.value) && o.value !== curr);
                o.innerText = o.text.replace(" (Busy)","") + (o.disabled ? " (Busy)" : "");
                s.appendChild(o);
            });
            s.value = curr; 
        });

        // 3. Update Pool
        document.getElementById('pool-leave').innerHTML = globalLeaves.map(l=>`<div class="staff-pill pill-leave">${l.name}</div>`).join("") || "<small style='color:#ccc'>None</small>";
        var freeHtml="", busyHtml="";
        globalStaff.forEach(s=>{
            if(assigned.includes(s.code)) busyHtml+=`<div class="staff-pill pill-busy">${s.name}</div>`;
            else freeHtml+=`<div class="staff-pill pill-free">${s.name}</div>`;
        });
        document.getElementById('pool-free').innerHTML = freeHtml;

        // 4. Validation
        for(var c in counts) {
            var cd = document.getElementById("card-"+c);
            if(cd) { if(counts[c]<2) { cd.classList.add("card-error"); err=true; } else cd.classList.remove("card-error"); }
        }
        document.getElementById('plan-status').innerHTML = filled===0?"‚ö™ Empty" : (err?"üü† Unfinished":"üü¢ Ready");
        genSummary();
    }

    function genSummary() {
        var d = new Date(document.getElementById('allocDate').value);
        var txt = `*Jungle Cubs Allocations*\nüìÖ ${d.getDate()} ${d.toLocaleString('default',{month:'short'})}\n\n`;
        var data={}; 
        document.querySelectorAll('.staff-select').forEach(s=>{
            if(s.value) {
                var city=s.getAttribute("data-city"), name=s.getAttribute("data-n");
                if(!data[city]) data[city]={}; if(!data[city][name]) data[city][name]=[];
                data[city][name].push(s.options[s.selectedIndex].text.replace(" (Busy)",""));
            }
        });
        Object.keys(data).sort().forEach(c=>{
            txt+=`*${c} Teams*\n`;
            for(var n in data[c]) txt+=`üìç *${n}*\n${data[c][n].join(", ")}\n\n`;
        });
        if(globalLeaves.length) { txt+="üî¥ *On Leave:*\n"; globalLeaves.forEach(l=>txt+=l.name+"\n"); }
        document.getElementById('summary-text').innerText = txt;
    }

    function copySummary() { 
        if(hasUnsavedChanges) {
            if(!confirm("‚ö†Ô∏è You have unsaved changes!\n\nIt is recommended to SAVE first so the database matches this summary.\n\nClick OK to Save & Copy, or Cancel to just Copy.")) {
                // Just Copy
                navigator.clipboard.writeText(document.getElementById('summary-text').innerText).then(()=>alert("Copied (Unsaved Changes)"));
                return;
            } else {
                // Save then Copy
                savePlan();
                setTimeout(() => { navigator.clipboard.writeText(document.getElementById('summary-text').innerText).then(()=>alert("Saved & Copied!")); }, 1500);
                return;
            }
        }
        navigator.clipboard.writeText(document.getElementById('summary-text').innerText).then(()=>alert("Copied!")); 
    }

    function changeDate(d) { var i=document.getElementById('allocDate'), x=new Date(i.value); x.setDate(x.getDate()+d); i.value=x.getFullYear()+'-'+String(x.getMonth()+1).padStart(2,'0')+'-'+String(x.getDate()).padStart(2,'0'); loadAllocations(); }
    
    // Alloc Actions
    function savePlan() {
        var d=document.getElementById('allocDate').value;
        var all={}, n={};
        document.querySelectorAll('.staff-select').forEach(s=>{
            var c=s.getAttribute("data-c"); if(!all[c]) all[c]=[];
            if(s.value) all[c].push(s.value); n[c]=s.getAttribute("data-n");
        });
        var btn=document.querySelector(".btn-action[onclick='savePlan()']"), old=btn.innerText; btn.innerText="Saving..."; btn.disabled=true;
        var fd=new FormData(); fd.append('type','saveAllocations'); fd.append('json',JSON.stringify({date:d,allocations:all,names:n}));
        fetch(SCRIPT_URL,{method:'POST',body:fd}).then(r=>r.json()).then(d=>{ 
            alert("Saved!"); btn.innerText=old; btn.disabled=false; hasUnsavedChanges=false; 
        });
    }
    
    function copyPlan(days) {
        var i=document.getElementById('allocDate'), t=new Date(i.value); t.setDate(t.getDate()+days);
        var ds=t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0')+'-'+String(t.getDate()).padStart(2,'0');
        if(!confirm("Copy from "+ds+"?")) return; captureHistory();
        fetch(SCRIPT_URL+"?action=getAllocationData&date="+ds).then(r=>r.json()).then(d=>{ if(d.savedPlan) { renderBoard(d.savedPlan); hasUnsavedChanges=true; } else alert("No plan found."); });
    }
    
    function resetPlan() { if(confirm("Reset Board?")) { captureHistory(); renderBoard(null); hasUnsavedChanges=true; } }
    
    function captureHistory() { if(!isInternalUpdate) { historyStack.push(getBoardState()); redoStack=[]; updateHistoryButtons(); } }
    function undo() { if(historyStack.length) { redoStack.push(getBoardState()); isInternalUpdate=true; renderBoard(historyStack.pop()); isInternalUpdate=false; updateHistoryButtons(); hasUnsavedChanges=true; } }
    function redo() { if(redoStack.length) { historyStack.push(getBoardState()); isInternalUpdate=true; renderBoard(redoStack.pop()); isInternalUpdate=false; updateHistoryButtons(); hasUnsavedChanges=true; } }
    function getBoardState() { var s={}; document.querySelectorAll('.staff-select').forEach(sel=>{ var c=sel.getAttribute("data-c"); if(!s[c]) s[c]=[]; s[c].push(sel.value); }); return s; }
    function updateHistoryButtons() { document.getElementById('btn-undo').disabled=!historyStack.length; document.getElementById('btn-redo').disabled=!redoStack.length; }

    // Utils
    function forceOut(c,n,s) { if(confirm("Force Out "+n+"?")) { var f=new FormData(); f.append('type','forceOut'); f.append('code',c); f.append('name',n); f.append('session',s); fetch(SCRIPT_URL,{method:'POST',body:f}).then(r=>r.json()).then(d=>fetchData()); } }
    function forceOutAll() { if(confirm("Force Close ALL?")) { var f=new FormData(); f.append('type','forceOutAll'); fetch(SCRIPT_URL,{method:'POST',body:f}).then(r=>r.json()).then(d=>{ alert("Closed "+d.count); fetchData(); }); } }
    function decide(ix,dec) { if(confirm(dec+"?")) { var l=dashboardData.pending.find(r=>r.rowIndex===ix); var f=new FormData(); f.append('type','decision'); f.append('rowIndex',ix); f.append('decision',dec); f.append('name',l.name); f.append('email',l.email); f.append('dates',l.start+" to "+l.end); f.append('mobile',l.mobile); fetch(SCRIPT_URL,{method:'POST',body:f}).then(r=>r.json()).then(d=>fetchData()); } }
    function changeMonth(d) { currentCalDate.setMonth(currentCalDate.getMonth()+d); renderCalendar(); }
    function filterHistory() { var v=document.getElementById('searchBox').value.toLowerCase(); document.querySelectorAll('.history-card').forEach(c=>c.style.display=c.innerText.toLowerCase().includes(v)?"flex":"none"); }
    function parseDate(d) { var p=d.split('/'); return new Date(p[2],p[1]-1,p[0]); }

</script>
</body>
</html>
