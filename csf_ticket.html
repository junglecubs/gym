<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="Cubs Sports Fest Ticket">
  <meta property="og:description" content="Entry Ticket for Cups Sports Fest">
  <title>Cubs Sports Fest Ticket</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

    body {
      font-family: 'Nunito', sans-serif;
      background-color: #ecf7f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px 0;
      overflow-x: hidden;
      /* Prevent horizontal scroll */
    }

    /* 
       FIXED LAYOUT STRATEGY:
       The ticket stays fixed at 800px width internally.
       We use a container to scale it down for mobile.
    */
    #scale-container {
      width: 800px;
      transform-origin: top center;
      /* Transform will be applied by JS */
    }

    .ticket-wrapper {
      position: relative;
      width: 800px;
      /* Fixed width */
      height: auto;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      border-radius: 20px;
      overflow: hidden;
      background: #fff;
    }

    /* The Ticket Image */
    .ticket-bg {
      width: 100%;
      display: block;
    }

    /* Overlay Container for Text */
    .ticket-details {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      color: #333;
    }

    /* CENTER SECTION */
    .section-center {
      position: absolute;
      top: 24%;
      left: 55%;
      transform: translateX(-50%);
      text-align: center;
      width: 44%;
    }

    .child-name {
      font-size: 28px;
      /* Corrected from 40px */
      font-weight: 900;
      color: #287844;
      margin-bottom: 2px;
      text-transform: uppercase;
      line-height: 1;
      white-space: nowrap;
    }

    .parent-details {
      font-size: 15px;
      /* Corrected from 19px */
      font-weight: 700;
      color: #111111;
      background: rgba(255, 255, 255, 0.25);
      padding: 4px 12px;
      border-radius: 10px;
      display: inline-block;
      line-height: 1.3;
      backdrop-filter: blur(1px);
      margin-top: 4px;
    }

    /* RIGHT SECTION */
    .section-right {
      position: absolute;
      top: 34%;
      right: -5%;
      width: 25%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .meta-details {
      margin-bottom: 8px;
      line-height: 1.2;
      color: #287844;
    }

    .batch-name {
      font-size: 20px;
      /* Corrected from 26px */
      font-weight: 900;
      display: block;
      margin-bottom: 6px;
    }

    .time-val {
      font-size: 10px;
      /* Reduced from 12px */
      font-weight: 700;
      display: block;
      color: #333;
      white-space: nowrap;
    }

    .row-id {
      font-size: 12px;
      /* Corrected from 14px */
      font-weight: 800;
      color: #888;
      margin-top: 2px;
      display: block;
    }

    .qr-code {
      width: 90px;
      /* Corrected from 176px */
      height: 90px;
      border: 3px solid white;
      border-radius: 8px;
    }

    /* Download Button */
    .actions {
      margin-top: 20px;
      text-align: center;
      z-index: 100;
    }

    .btn-download {
      background: #287844;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(40, 120, 68, 0.3);
      transition: transform 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-download:active {
      transform: scale(0.95);
    }

    /* Loading Overlay */
    #loadingMsg {
      margin-top: 10px;
      color: #555;
      font-size: 14px;
      font-style: italic;
    }

    /* FLOATING CHARACTERS (Decorative) - Fixed size logic not needed for bg elements */
    .jungle-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
      overflow: hidden;
    }

    .char {
      position: absolute;
      width: 120px;
      opacity: 0.8;
      animation: float 6s ease-in-out infinite;
    }

    .c1 {
      top: 10%;
      left: 5%;
    }

    .c2 {
      bottom: 10%;
      right: 5%;
      animation-delay: 1s;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-15px);
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>

  <div class="jungle-scene">
    <img src="https://i.postimg.cc/P5f3PB9b/Monkey_climbing_cam2.webp" class="char c1" alt="Cub 1">
    <img src="https://i.postimg.cc/mgZXt0Jy/Yoga_poses_for_work_monkey.webp" class="char c2" alt="Cub 2">
  </div>

  <!-- Container that gets scaled via JS -->
  <div id="scale-container">
    <div class="ticket-wrapper" id="ticketArea">
      <!-- background image -->
      <img src="CSF TICKET FORMAT.jpg" alt="Ticket Background" class="ticket-bg">

      <div class="ticket-details">

        <!-- Center Section -->
        <div class="section-center">
          <div class="child-name" id="childName">Super Cub</div>
          <div class="parent-details">
            <div id="parentName">Parent</div>
            <div id="mobile" style="font-size: 0.9em; margin-top: 2px;">+91 9876543210</div>
          </div>
        </div>

        <!-- Right Section -->
        <div class="section-right">
          <div class="meta-details">
            <span class="batch-name" id="batch">Morning</span>
            <span class="time-val" id="time">08:00 AM</span>
            <span class="row-id" id="rowId">#001</span>
          </div>
          <!-- QR Code -->
          <img id="qrImg" src="" class="qr-code" alt="QR">
        </div>

      </div>
    </div>
  </div>

  <div class="actions">
    <button class="btn-download" onclick="downloadTicket()">
      ðŸ“¥ Download Ticket
    </button>
    <div id="loadingMsg">Preparing your ticket...</div>
  </div>

  <script>
    // 0. SCALING LOGIC FOR MOBILE
    function scaleTicket() {
      const container = document.getElementById('scale-container');
      const screenWidth = window.innerWidth;
      const ticketWidth = 800;
      const margin = 20; // 10px padding on each side

      // Calculate scale factor (max 1 for desktop)
      let scale = (screenWidth - margin) / ticketWidth;
      if (scale > 1) scale = 1;

      // Apply scale
      container.style.transform = `scale(${scale})`;

      // Adjust layout height so footer elements aren't miles away
      // The box actually takes up less space now, but DOM reserves full 800px height.
      // Approximate height compensation:
      // Original Height ~266px (aspect ratio dependent)
      // New Height = Original * scale
      // Negative margin bottom helps pull up the button
      const height = container.offsetHeight; // Approx 266
      const wastedSpace = height * (1 - scale);
      container.style.marginBottom = `-${wastedSpace}px`;
    }

    window.addEventListener('resize', scaleTicket);
    // Call immediately
    window.addEventListener('DOMContentLoaded', scaleTicket);


    // 1. Get URL Parameters
    const params = new URLSearchParams(window.location.search);
    const childName = params.get('name') || 'Super Cub';
    const parentName = params.get('parent') || 'Parent Name';
    const mobile = params.get('mobile') || '9876543210';
    let batch = params.get('batch') || 'Morning';
    const rowId = params.get('id') || '001';

    // Cleanup Batch Name
    batch = batch.replace(/Batch/i, '').trim();

    // Deduce Time
    let timeDisplay = "Time: TBA";
    if (batch.toLowerCase().includes('morning')) {
      timeDisplay = "09:30 AM - 11:30 AM";
    } else if (batch.toLowerCase().includes('afternoon') || batch.toLowerCase().includes('mid')) {
      timeDisplay = "03:30 PM - 05:30 PM";
    } else if (batch.toLowerCase().includes('evening')) {
      timeDisplay = "05:45 PM - 07:45 PM";
    }

    // 2. Update UI
    document.getElementById('childName').textContent = childName;
    document.getElementById('parentName').textContent = parentName;
    document.getElementById('mobile').textContent = mobile;
    document.getElementById('batch').textContent = batch;
    document.getElementById('time').textContent = timeDisplay;
    document.getElementById('rowId').textContent = 'ID: #' + rowId;

    // 3. Generate QR Code
    const qrText = `âœ… VALID TICKET\n------------------\nChild: ${childName}\nParent: ${parentName}\nMobile: ${mobile}\nBatch: ${batch}\nTime: ${timeDisplay}\nID: ${rowId}`;
    document.getElementById('qrImg').src = `https://quickchart.io/qr?text=${encodeURIComponent(qrText)}&size=300&dark=000&ecLevel=M&margin=1`;

    // 4. Download Function - ROBUST OFF-SCREEN STRATEGY
    function downloadTicket() {
      const btn = document.querySelector('.btn-download');
      const originalTicket = document.getElementById('ticketArea');

      btn.textContent = "Generating High-Res Ticket...";
      document.getElementById('loadingMsg').textContent = "Processing...";

      // Create a cloned container specifically for capture
      // This ensures we capture the ticket at exactly 800px width with no scaling artifacts
      const wrapper = document.createElement('div');
      wrapper.style.position = 'fixed';
      wrapper.style.top = '-10000px'; // Off-screen
      wrapper.style.left = '0';
      wrapper.style.width = '800px'; // Force correct width
      wrapper.style.zIndex = '-1';
      // Ensure webkit doesn't mess with fonts in the clone
      wrapper.style.webkitTextSizeAdjust = 'none';
      wrapper.innerHTML = originalTicket.innerHTML;

      // Copy computed styles for text/layout correctness if needed, 
      // but usually innerHTML + linked CSS is enough. 
      // We manually add the class to ensure it picks up styles
      wrapper.className = 'ticket-wrapper';

      document.body.appendChild(wrapper);

      // Wait a tick for DOM to render the clone
      setTimeout(() => {
        html2canvas(wrapper, {
          scale: 2, // 1600px width output
          useCORS: true,
          width: 800, // Explicitly tell html2canvas the width
          windowWidth: 800, // Mock window width
          backgroundColor: null
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = `CSF_Ticket_${childName.replace(/\s+/g, '_')}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();

          btn.textContent = "ðŸ“¥ Download Again";
          document.getElementById('loadingMsg').textContent = "Download started!";

          // Cleanup
          document.body.removeChild(wrapper);
        }).catch(err => {
          console.error(err);
          alert("Could not generate image. Please screenshot.");
          btn.textContent = "ðŸ“¥ Download Ticket";
          if (document.body.contains(wrapper)) document.body.removeChild(wrapper);
        });
      }, 100);
    }

    // 5. AUTO-DOWNLOAD ATTEMPT
    window.onload = function () {
      // Small delay to ensure images (QR, Bg) are loaded
      setTimeout(() => {
        scaleTicket(); // Ensure scale is correct

        // Attempt download automatically
        // Note: Browsers may block this popup/download.
        document.getElementById('loadingMsg').textContent = "Attempting auto-download...";
        downloadTicket();
      }, 1500);
    };

  </script>
</body>

</html>