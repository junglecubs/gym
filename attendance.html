<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jungle Cubs Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        
        .logo { font-size: 24px; font-weight: bold; color: #287844; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; font-size: 13px; font-weight: bold; color: #555; margin-bottom: 8px; }
        
        input, select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; box-sizing: border-box; transition: 0.3s; background: #fafafa; -webkit-appearance: none; }
        input:focus, select:focus { border-color: #287844; background: white; outline: none; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        button { padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.96); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .btn-in { background: #287844; } /* Jungle Green */
        .btn-out { background: #c72e31; } /* Red */
        .btn-disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        #status-msg { margin-top: 25px; font-size: 14px; padding: 15px; border-radius: 10px; display: none; line-height: 1.5; }
        .status-success { background: #e8f5e9; color: #287844; border: 1px solid #287844; }
        .status-error { background: #fdecea; color: #c72e31; border: 1px solid #c72e31; }
        
        /* Spinner */
        .loader { display: none; margin: 15px auto; border: 4px solid #f3f3f3; border-top: 4px solid #287844; border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

  <div class="container">
    <div class="logo">üìç Jungle Cubs GPS</div>
    
    <div class="input-group">
      <label>Employee Code</label>
      <input type="text" id="empCode" placeholder="Enter Code (e.g. JC001)" onchange="verifyCode()" style="text-transform: uppercase;">
    </div>
    <div class="input-group">
      <label>Name</label>
      <input type="text" id="empName" placeholder="Auto-verifying..." readonly style="background:#f0f0f0; color:#666;">
    </div>

    <div class="input-group">
      <label>Select Session</label>
      <select id="sessionType">
        <option value="Morning - Head Office">‚òÄÔ∏è Morning - Head Office</option>
        <option value="Evening - Centre">üåô Evening - Centre</option>
      </select>
    </div>

    <div class="input-group">
      <label>Current Location</label>
      <select id="locationSelect">
        <option value="" disabled selected>Loading locations...</option>
      </select>
    </div>

    <div class="btn-grid">
      <button class="btn-in btn-disabled" id="btnIn" onclick="handleAttendance('Check-In')" disabled>IN</button>
      <button class="btn-out btn-disabled" id="btnOut" onclick="handleAttendance('Check-Out')" disabled>OUT</button>
    </div>

    <div class="loader" id="loader"></div>
    <div id="status-msg"></div>

  </div>

<script>
    // --- CONFIGURATION ---
    // ‚ö†Ô∏è PASTE YOUR GOOGLE WEB APP URL HERE
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzyHoKRrOGN--0uenvSsY4JV7JnpL8B2mGx-pt5lbK4-zeiTZs0UGkj5fD13MhqN_hE/exec'; 
    // ---------------------

    let locations = [];

    window.onload = function() {
      // 1. Lock Buttons Immediately
      lockButtons("Loading...");

      // 2. Set Smart Default Session
      setSmartSession();

      // 3. Fetch Locations
      fetch(SCRIPT_URL + "?action=getLocations")
        .then(res => res.json())
        .then(data => {
            locations = data;
            populateLocations();
            detectAndSelectNearest();
            // Buttons remain locked until user enters a valid code
            resetButtons(); 
        })
        .catch(e => {
            showError("‚ö†Ô∏è Unable to connect to server.");
            console.error(e);
        });
    };

    function setSmartSession() {
        var now = new Date();
        var currentHour = now.getHours(); 
        var select = document.getElementById('sessionType');
        if (currentHour >= 15) {
            select.value = "Evening - Centre";
        } else {
            select.value = "Morning - Head Office";
        }
    }

    function populateLocations() {
        const select = document.getElementById('locationSelect');
        select.innerHTML = '<option value="" disabled selected>Select Current Location</option>';
        locations.forEach(loc => {
            let opt = document.createElement('option');
            opt.value = loc.code;
            opt.text = loc.name;
            select.appendChild(opt);
        });
    }

    function detectAndSelectNearest() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                findNearest(position.coords.latitude, position.coords.longitude);
            }, (error) => { console.log("GPS waiting..."); });
        }
    }

    function findNearest(lat, lng) {
        let minDist = 1000000; 
        let nearestCode = "";
        locations.forEach(loc => {
            let d = getDistanceFromLatLonInM(lat, lng, loc.lat, loc.lng);
            if (d < minDist) { minDist = d; nearestCode = loc.code; }
        });
        if (nearestCode && minDist < 2000) { 
            const select = document.getElementById('locationSelect');
            select.value = nearestCode;
            const option = select.querySelector(`option[value="${nearestCode}"]`);
            if(option) option.text = "üìç " + option.text + " (Detected)";
        }
    }

    function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
      var R = 6371000; 
      var dLat = deg2rad(lat2 - lat1); var dLon = deg2rad(lon2 - lon1);
      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI / 180); }

    // --- BUTTON STATE MANAGEMENT ---
    function lockButtons(msg) {
        var btnIn = document.getElementById('btnIn');
        var btnOut = document.getElementById('btnOut');
        
        btnIn.disabled = true; btnIn.classList.add('btn-disabled'); btnIn.style.opacity = "0.6";
        btnOut.disabled = true; btnOut.classList.add('btn-disabled'); btnOut.style.opacity = "0.6";
        
        if(msg) {
            btnIn.innerText = "‚óè ‚óè ‚óè";
            btnOut.innerText = "‚óè ‚óè ‚óè";
        }
    }

    function resetButtons() {
        // Reset to default "Ready" state (but still disabled until code is valid)
        var btnIn = document.getElementById('btnIn');
        var btnOut = document.getElementById('btnOut');
        btnIn.innerText = "IN";
        btnOut.innerText = "OUT";
    }

    function verifyCode() {
        var codeInput = document.getElementById('empCode');
        var nameField = document.getElementById('empName');
        var code = codeInput.value.trim().toUpperCase();
        
        if(code.length < 3) return;

        // VISUAL FEEDBACK START
        nameField.value = "Verifying...";
        lockButtons("Verifying...");

        fetch(SCRIPT_URL + "?action=lookupEmployee&code=" + code)
            .then(res => res.json())
            .then(data => {
                if(data.found) {
                    nameField.value = data.name;
                    nameField.style.color = "#287844"; 
                    nameField.style.fontWeight = "bold";
                    
                    // Found user? Now check for Auto-Switch
                    detectActiveSession(code);
                } else {
                    nameField.value = "";
                    alert("‚ùå Employee Code not found.");
                    codeInput.value = "";
                    resetButtons();
                }
            });
    }

    function detectActiveSession(code) {
        // Keep locked
        fetch(SCRIPT_URL + "?action=findActiveSession&code=" + code)
            .then(res => res.json())
            .then(data => {
                if (data.active) {
                    var select = document.getElementById('sessionType');
                    select.value = data.session; 
                }
                // Finally, check status for the (possibly new) session
                checkStatus();
            });
    }

    function checkStatus() {
        var code = document.getElementById('empCode').value.trim().toUpperCase();
        var session = document.getElementById('sessionType').value;
        var btnIn = document.getElementById('btnIn');
        var btnOut = document.getElementById('btnOut');

        if(code.length < 3) return;

        lockButtons("Syncing...");

        fetch(SCRIPT_URL + "?action=getStatus&code=" + code + "&session=" + session)
            .then(res => res.json())
            .then(data => {
                // UNLOCK
                btnIn.disabled = false; btnIn.classList.remove('btn-disabled'); btnIn.style.opacity = "1"; btnIn.innerText = "IN";
                btnOut.disabled = true; btnOut.classList.add('btn-disabled'); btnOut.style.opacity = "1"; btnOut.innerText = "OUT";

                if (data.status === "Check-In") {
                    // LOCKED IN STATE
                    btnIn.disabled = true; btnIn.classList.add('btn-disabled');
                    btnIn.innerText = "Checked In (" + data.time + ")";
                    
                    btnOut.disabled = false; btnOut.classList.remove('btn-disabled');
                    
                    // UPDATED MESSAGE WITH LOCATION
                    showSuccess("‚ÑπÔ∏è You are currently Checked In at <strong>" + data.location + "</strong>.<br>Click OUT when you leave.");
                    
                } else if (data.status === "Check-Out") {
                    showSuccess("‚ÑπÔ∏è You checked out at " + data.time);
                } else {
                    document.getElementById('status-msg').style.display = 'none';
                }
            });
    }

    document.getElementById('sessionType').addEventListener('change', checkStatus);

    function handleAttendance(action) {
        var code = document.getElementById('empCode').value;
        var name = document.getElementById('empName').value;
        var locCode = document.getElementById('locationSelect').value;
        
        if(!name || name.includes("Verifying") || !code) { alert("Please enter a valid Employee Code first."); return; }
        if(!locCode) { alert("Please select your location."); return; }

        lockButtons("Processing..."); // Lock while sending
        document.getElementById('loader').style.display = 'block';
        document.getElementById('status-msg').style.display = 'none';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => { sendData(position.coords.latitude, position.coords.longitude, action, locCode); },
                (error) => { handleGpsError(error); },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            showError("GPS not supported.");
            resetButtons(); // Unlock if error
        }
    }

    function sendData(lat, lng, action, locCode) {
        var targetLoc = locations.find(l => l.code === locCode);
        
        var formData = new FormData();
        formData.append('type', 'attendance');
        formData.append('employeeCode', document.getElementById('empCode').value);
        formData.append('session', document.getElementById('sessionType').value);
        formData.append('action', action);
        formData.append('userLat', lat);
        formData.append('userLng', lng);
        formData.append('targetLat', targetLoc.lat);
        formData.append('targetLng', targetLoc.lng);
        formData.append('radius', targetLoc.radius);
        formData.append('locationName', targetLoc.name);

        fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loader').style.display = 'none';
                if(data.result === 'success') {
                    showSuccess(data.message);
                    checkStatus(); // Re-run checks to update button state
                } else {
                    showError(data.message);
                    // Unlock buttons so they can try again (e.g. if they picked wrong location)
                    checkStatus(); 
                }
            })
            .catch(e => {
                document.getElementById('loader').style.display = 'none';
                showError("‚ö†Ô∏è Network Error.");
                checkStatus();
            });
    }

    function handleGpsError(error) {
        // Unlock if GPS fails
        checkStatus();
        document.getElementById('loader').style.display = 'none';
        if(error.code == 1) showError("‚ö†Ô∏è Location Denied.");
        else if(error.code == 2) showError("‚ö†Ô∏è GPS Signal Unavailable.");
        else showError("‚ö†Ô∏è GPS Error: " + error.message);
    }

    function showSuccess(msg) {
        var el = document.getElementById('status-msg');
        el.className = "status-success";
        el.innerHTML = msg.replace(/\n/g, "<br>");
        el.style.display = "block";
    }

    function showError(msg) {
        var el = document.getElementById('status-msg');
        el.className = "status-error";
        el.innerHTML = msg.replace(/\n/g, "<br>");
        el.style.display = "block";
    }
</script>

</body>
</html>